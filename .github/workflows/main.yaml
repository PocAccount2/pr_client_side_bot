name: main workflow

on: pull_request

jobs:
  code_review:
    name: client side code review
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Fetch PR diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr diff ${{ github.event.pull_request.number }} > pr_diff.txt

      - name: Read diff file
        id: read_diff
        run: |
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          cat pr_diff.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Gemini CLI
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0.1.16
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            You are a senior security engineer.

            Perform a **client-side code review** using ONLY the information below.

            --- PR TITLE ---
            ${{ github.event.pull_request.title }}

            --- PR DESCRIPTION ---
            ${{ github.event.pull_request.body }}

            --- CODE DIFF ---
            ```
            ${{ steps.read_diff.outputs.diff }}
            ```

            Review priorities:
            1. ðŸ”´ Security issues (XSS, DOM injection, hardcoded secrets)
            2. ðŸŸ  Bugs & logic errors
            3. ðŸ”µ Code quality & maintainability

            Output format:
            - ðŸ”´ Critical Security Issues
            - ðŸŸ  Bugs / Logical Errors
            - ðŸ”µ Code Quality
            - âœ… Overall Recommendation

            Be concise and actionable.

      - name: Create PR comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "${{ steps.gemini.outputs.text }}" > gemini_comment.md
          gh pr comment ${{ github.event.pull_request.number }} \
            --body-file gemini_comment.md